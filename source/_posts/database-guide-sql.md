title: 关系型数据库开发简明教程(2)——建库建表及基本SQL
date: 2015-09-20 23:35:14
tags:
---

前面我们大致介绍了关系型数据库的一些基本知识，这次我们将开始介绍如何使用SQL来建库、建表，为后面的学习打下基础。

MySQL数据库系统是以`mysqld`服务器为中心的客户端-服务器架构。服务器是“真正”去操作数据库的程序，服务器可以安装在任何地方，只要客户端能够连接上就行。

客户端和服务器的交互都是先连接到服务器，发送SQL语句执行数据库操作，然后从服务器接受执行结果。其中的一个客户端就是包含在MySQL安装包中的`mysql`程序，它可以交互式的进行使用（从shell里面输入语句、然后发送到MySQL服务器执行，最后显示执行结果），这在我们进行快速学习、实验时非常有用。下面的例子都将在shell下面使用`mysql`程序。

# 建库及赋权

我们使用root账号登陆客户端`mysql -u root -p`，然后执行：

```sql
CREATE DATABASE `sample` DEFAULT CHARACTER SET utf8;
```

就创建了名为sample的数据库，并将数据的字符集设置为utf8。如果我们执行`show databases;`，应该可以看到刚创建好的数据库了。

目前为止，我们都是直接使用root账号来进行数据库的操作，这不是太安全（就好像我们都不会直接使用root账号来使用unix一样）。更好的做法是单独为数据库创建用户，并将相关权限赋予该用户。执行如下命令：

```sql
GRANT ALL ON sample.* TO 'kohpoll'@'localhost' IDENTIFIED BY '123';
```

将sample数据库的所有操作权限赋予kohpoll这个用户，密码是123，并且这个用户的连接地址是localhost（也就是说只能从本地来连接数据库，其他地址不可以）。

我们可以只赋予部分操作权限：

```sql
GRANT SELECT, INSERT ON sample.* TO 'kohpoll'@'localhost' IDENTIFIED BY '123';
```

可以只赋予某个表的权限：

```sql
GRANT SELECT, INSERT ON sample.users TO 'kohpoll'@'localhost' IDENTIFIED BY '123';
```

可以赋予全部数据库及所有表的权限：

```sql
GRANT ALL ON *.* TO 'kohpoll'@'localhost' IDENTIFIED BY '123';
```

可以允许从任何地址连接数据库：

```sql
GRANT ALL ON sample.* TO 'kohpoll'@'%' IDENTIFIED BY '123';
```

做个总结就是，`GRANT`命令的格式如下：

```sql
GEANT 权限1,权限2,…权限n ON 数据库名称.表名称 to '用户名'@'用户地址'' IDENTIFIED BY '连接口令';
```

好了。我们现在先退出mysql客户端，使用刚刚建好的用户kohpoll来进行登录：`mysql -u kohpoll -p`，输入密码123。

登陆后我们会发现我们的权限受到了很大“限制”，比如执行`CREATE DATABASE sample2`将会失败，执行`show databases;`将不再能看到所有数据库等等。

# 创建表

建好数据库了，那我们接着就来创建表。

使用执行`USE sample;`来切换到sample数据库。

执行如下SQL来创建一张名为users的表：

```sql
CREATE TABLE `users`
(
  `id` INTEGER NOT NULL AUTO_INCREMENT,
  `nick` VARCHAR(16) NOT NULL,
  `gender` INTEGER NOT NULL DEFAULT 1,
  `telphone` CHAR(11) NULL,
  `createdAt` DATETIME NOT NULL,
  PRIMARY KEY(`id`)
) ENGINE=InnoDB;
```

创建表，需要提供如下信息：表名，列信息（列名及列定义，用逗号分隔）。表的主键则是使用`PRIMARY KEY`来进行指定。

列定义主要指定了列名、列的数据类型（如：DATETIME）、数据属性（如：NOT NULL、AUTO_INCREMENT）。

## 数据类型

MySQL的数据类型主要包括3类：数值、字符串、日期时间。下面我们进行一个简要介绍（并没有介绍全部类型）。

### 数值

数值类型和C语言之类的语言里面的数据类型类似，会分出很多的类型，表示不同范围的数值大小，从而占据不同大小的存储空间。

#### 整形

整形的数值类型就是存储整数，可以使用`UNSIGNED`来表示无符号的数值，这时范围会不一样（比如：`INT UNSIGNED`）。

  - TINYINT，1字节，范围（-128~127，如果是无符号，为0~255）
  - SMALLINT，2字节，范围（-2^15~2^15-1，如果是无符号，为0~2^16-1）
  - MEDIUMINT，3字节，范围（-2^23~2^23-1，如果是无符号，为0~2^24-1）
  - INT（或者INTEGER），4字节，范围（-2^31~2^31-1，如果是无符号，为0~2^32-1）
  - BIGINT，8字节，范围（-2^63~2^63-1，如果是无符号，为0~2^64-1）

#### 浮点型

浮点型存储小数，下面的表示方法中m表示总个数，d表示小数位。比如：FLOAT(7, 4)，会表示为：999.9999，总个数为7，小数点后个数为4。当插入的时候会对浮点数进行舍入。比如：插入999.00009，最终会存储为，999.0001。

  - FLOAT(m, d)，4字节，单精度浮点数
  - DOUBLE(m, d)，8字节，双精度浮点数
  - DECIMAL(m, d)，精度可变浮点数

浮点数比较坑，我没有实际使用过，请谨慎使用。因为MySQL其实没有货币类型，如果真的需要和价格打交道，可以考虑将价格统一转换为分（去除小数点）进行存储，在代码层面来进行运算。比如：将10.25元存储为1025，取得时候再转回来。

### 字符串

字符串类型用的比较多，有2种基本的串类型：固定长度和可变长度。固定长度表示不管我实际存储的值是啥，我都会将其存储为指定的固定长度，不足的使用空字符串补足，多余的就截掉。可变长度则是，如果我实际存储的值不到我指定的长度，就只会存储那个长度（不会进行补齐），如果超过了则进行截取。

  - CHAR(n)，固定长度，最多255个字符
  - VARCHAR(n)，可变长度，最多65535个字符
  - TINYTEXT，可变长度，最多255个字符
  - TEXT，可变长度，最多65535个字符
  - MEDIUMTEXT，可变长度，最多2^14-1个字符
  - TINYTEXT，可变长度，最多2^32-1个字符

需要注意的是，这里的CHAR和VCHAR括号里面的n代表的是字符个数，不是字节数。比如，声明CHAR(8)和VARCHAR(8)，使用utf8字符集。如果存储的是“中”这个汉字，那CHAR会占用10个字节（1个中文字符3字节加上补位的7个空字符串占用7个字节），而VARCHAR只会占用4个或5个字节（有1个或2个字节用来记录串长度）。

另外，上面所说的最大字符长度都是基于单字节字符集来说的，如果是utf8这种字符集，实际的最大字符长度会变小。比如，TEXT在单字节编码下最大字符长度是65535个字符，如果是utf8字符集，可能的最大长度就会变成21845个字符（65535/3）。

### 日期和时间

日期和时间类型使用也比较多，比如：数据的创建时间、更新时间等。另外MySQL提供了很多函数来进行日期和时间的操作，大家感兴趣的可以自行搜索。

  - DATE，3字节，格式（1989-10-19）
  - TIME，3字节，格式（08:09:20）
  - DATETIME，8字节，格式（1989-10-19 08:09:20）
  - TIMESTAMP，4字节，时间戳（功能和DATETIME相同，但范围较小）
  - YEAR，1字节，年份

就我个人使用来看，大多时候使用DATETIME就足够，因为其他信息完全可以从DATETIME中获取到。

## 数据属性

除了数据类型，我们还会使用数据属性来对数据进行补充描述，下面介绍一些常用的数据属性。

### 自增列（AUTO_INCREMENT）

当新插入行时，该列会被赋一个唯一的整数标志，不断加1。一般会为主键列指定，而且每个表只允许有一个AUTO_INCREMENT列。

### 空（NULL）及不为空（NOT NULL）

NULL值就是没有值或者缺值（和空字符串不同，空字符串其实是一个有效的字符串值）。允许NULL的列在插入或者更新行时可以不提供值，而不允许（NOT）NULL的列在插入或者更新行时必须提供值。

### 提供默认值（DEFAULT）

在插入或者更新行时，如果没有提供值，可以让MySQL指定一个默认的常量值（必须是常量，不能是函数）。比如：DEFAULT 1、DEFAULT 'a'等。另外，如果列已经被指定了NULL，那不指定DEFAULT，默认值就会是NULL。

### 其他

  - 使用UNIQUE来确保该列在表里都有不同的值（NULL可以重复）
  - 前面说的使用UNSIGNED来表示无符号整数
  - 对数值类型使用ZEROFILL会将0来填充剩余字段空间

# 操作表

创建表后，可能我们会经常需要对表结构进行更改（增加列、删除列，修改列定义等等）、或者直接将表删除、重命名表等。下面介绍对表进行操作的方法。

## 更新表定义

更改表定义使用`ALTER TABLE`语句。如下所示。

增加列：

```sql
ALTER TABLE `users` ADD updatedAt DATETIME NOT NULL;
```

删除列：

```sql
ALTER TABLE `users` DROP COLUMN `gender`;
```

修改列定义：

```sql
ALTER TABLE `users` CHANGE `nick` `nick` VARCHAR(32) NOT NULL;
```

`ALTER TABLE`还经常用来定义外键、索引，我们后面的文章将会进行详细介绍。

## 删除表

删除表很简单，直接使用`DROP TABLE`。删除表不能撤销，将被永久删除，请小心。如下所示。

```sql
DROP TABLE `users`;
```

## 重命名表

对表名不满意时，可以使用`RENAME TABLE`语句来重命名表。如下所示：

```sql
RENAME TABLE `user` TO `users`;
```

## 总结

这一篇内容挺多，我们介绍了如何使用SQL语句来创建数据库并为用户赋予数据库权限，如何创建表及对表结构进行更改，SQL的基本数据类型及数据属性。下一篇我们将介绍更有意思的内容，数据的设计及表间关系的表示。