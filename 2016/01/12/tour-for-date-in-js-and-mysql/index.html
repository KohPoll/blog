<!doctype html>




<html class="theme-next pisces">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  <link href="/blog/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">





<link href="/blog/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Node.js,JavaScript,Frontend Engineer">













<meta name="description" content="最近使用 sequelize 过程中发现一个“奇怪”的问题，将某个时间插入到表中后，通过 sequelize 查询出来的时间和通过 mysql 命令行工具查询出来的时间不一样。非常困惑，于是研究了下，下面是学习成果。">
<meta property="og:type" content="article">
<meta property="og:title" content="关于“时间”的一次探索">
<meta property="og:url" content="http://kohpoll.github.io/blog/2016/01/12/tour-for-date-in-js-and-mysql/index.html">
<meta property="og:site_name" content="kohpoll&#39;s blog">
<meta property="og:description" content="最近使用 sequelize 过程中发现一个“奇怪”的问题，将某个时间插入到表中后，通过 sequelize 查询出来的时间和通过 mysql 命令行工具查询出来的时间不一样。非常困惑，于是研究了下，下面是学习成果。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-09-17T08:30:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于“时间”的一次探索">
<meta name="twitter:description" content="最近使用 sequelize 过程中发现一个“奇怪”的问题，将某个时间插入到表中后，通过 sequelize 查询出来的时间和通过 mysql 命令行工具查询出来的时间不一样。非常困惑，于是研究了下，下面是学习成果。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"hide"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 关于“时间”的一次探索 | kohpoll's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  








  <div style="display: none;">
    <script src="http://s6.cnzz.com/stat.php?id=1258937997&web_id=1258937997" type="text/javascript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">kohpoll's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                关于“时间”的一次探索
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-12T00:00:00+08:00" content="2016-01-12">
              2016-01-12
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/blog/2016/01/12/tour-for-date-in-js-and-mysql/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/12/tour-for-date-in-js-and-mysql/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近使用 <code>sequelize</code> 过程中发现一个“奇怪”的问题，将某个时间插入到表中后，通过 <code>sequelize</code> 查询出来的时间和通过 <code>mysql</code> 命令行工具查询出来的时间不一样。非常困惑，于是研究了下，下面是学习成果。</p>
<a id="more"></a>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>我们先来介绍一些可能当年在地理课上学习过的基本概念。</p>
<p>说起来，时间真是一个神奇的东西。以前人们通过观察太阳的位置来决定时间（比如：使用日晷），这就使得不同经纬度的地区时间是不一样的。后来人们进一步规定以子午线为中心，向东西两侧延伸，每 15 度划分一个时区，刚好是 24 个时区。然后因为一天有 24 小时，地球自转一圈是 360 度，360 度 / 24 小时 = 15 度/小时，所以每差一个时区，时间就差一个小时。</p>
<p>最开始的标准时间（子午线中心处的时间）是英国伦敦的皇家格林威治天文台的标准时间（因为它刚好在本初子午线经过的地方），这就是我们常说的 <code>GMT</code>（Greenwich Mean Time）。然后其他各个时区根据标准时间确定自己的时间，往东的时区时间晚（表示为 GMT+hh:mm）、往西的时区时间早（表示为 GMT-hh:mm）。比如，中国标准时间是东八区，我们的时间就总是比 <code>GMT</code> 时间晚 8 小时，他们在凌晨 1 点，我们已经是早晨 9 点了。</p>
<p>但是 <code>GMT</code> 其实是根据地球自转、公转计算的（太阳每天经过英国伦敦皇家格林威治天文台的时间为中午 12 点），不是非常准确，于是后面提出了根据原子钟计算的标准时间 <code>UTC</code>（Coordinated Universal Time）。</p>
<p>一般情况下，<code>GMT</code> 和 <code>UTC</code> 可以互换，但是实际上，<code>GMT</code> 是一个时区，而 <code>UTC</code> 是一个时间标准。</p>
<p>可以在这里看到所有的时区：<a href="http://www.timeanddate.com/time/map/" target="_blank" rel="noopener">http://www.timeanddate.com/time/map/</a></p>
<p>所以，当我们“展示”某个时间时，明确时区就变得非常重要了。不然你只说现在是 <code>2016-01-11 19:30:00</code>，然后不告诉我时区，我其实是没法准确知道时间的（当然，我可以认为这个时间是我所在时区的当地时间）。如果你说现在是 <code>2016-01-11 19:30:00 GMT+0800</code>，那我就知道这个时间是东八区的时间了。如果我在东八区，那时间就是 19:30，如果我在 <code>GMT</code> 时区，那时间就是 11:30（减掉 8 小时）。</p>
<h2 id="JavaScript-中的“时间”"><a href="#JavaScript-中的“时间”" class="headerlink" title="JavaScript 中的“时间”"></a>JavaScript 中的“时间”</h2><p>我们现在来介绍下 JavaScript 中的“时间”，包括：<code>Date</code>、<code>Date.parse</code>、<code>Date.UTC</code>、<code>Date.now</code>。</p>
<p>注：下面的代码示例可以在 node shell 里面运行，如果你运行的时候结果和下面的不一致，那可能咱们不在一个时区：）</p>
<h3 id="Date-构造器"><a href="#Date-构造器" class="headerlink" title="Date 构造器"></a>Date 构造器</h3><p>构造时间的方法有下面几种：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Date</span>();           <span class="comment">// 当前时间</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Date</span>(value);      <span class="comment">// 自 1970-01-01 00:00:00 UTC 经过的毫秒数</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Date</span>(dateString); <span class="comment">// 时间字符串</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Date</span>(year, month[, day[, hour[, minutes[, seconds[, milliseconds]]]]]);</span><br></pre></td></tr></table></figure>
<p>需要注意的是：构造出的日期用来显示时，会被转换为本地时间（调用 <code>toString</code> 方法）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">Mon Jan <span class="number">11</span> <span class="number">2016</span> <span class="number">20</span>:<span class="number">15</span>:<span class="number">18</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>打印出我写这篇文章时的本地时间。后面的 <code>GMT+0800</code> 表示是“东八区”，<code>CST</code> 表示是“中国标准时间（China Standard Time）”。</p>
<p>有一个很“诡异”的地方是如果我们直接使用 <code>Date</code>，而不是 <code>new Date</code>，得到的将会是字符串，而不是 <code>Date</code> 类型的对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">typeof</span> <span class="built_in">Date</span>()</span><br><span class="line"><span class="string">'string'</span></span><br><span class="line">&gt; <span class="keyword">typeof</span> <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"><span class="string">'object'</span></span><br></pre></td></tr></table></figure>
<h4 id="时间字符串"><a href="#时间字符串" class="headerlink" title="时间字符串"></a>时间字符串</h4><p>我们先说最复杂的时间字符串形式。它实际上支持两种格式：一种是 RFC-2822 的标准；另一种是 ISO 8601 的标准。我们主要介绍后一种。</p>
<h5 id="ISO-8601"><a href="#ISO-8601" class="headerlink" title="ISO 8601"></a>ISO 8601</h5><p>ISO 8601的标准格式是：<code>YYYY-MM-DDTHH:mm:ss.sssZ</code>，分别表示：</p>
<ul>
<li><code>YYYY</code>：年份，0000 ~ 9999</li>
<li><code>MM</code>：月份，01 ~ 12</li>
<li><code>DD</code>：日，01 ~ 31</li>
<li><code>T</code>：分隔日期和时间</li>
<li><code>HH</code>：小时，00 ~ 24</li>
<li><code>mm</code>：分钟，00 ~ 59</li>
<li><code>ss</code>：秒，00 ~ 59</li>
<li><code>.sss</code>：毫秒</li>
<li><code>Z</code>：时区，可以是：<code>Z</code>（UFC）、<code>+HH:mm</code>、<code>-HH:mm</code></li>
</ul>
<p>这里我们主要来说下 <code>T</code>、以及 <code>Z</code>。</p>
<h6 id="T"><a href="#T" class="headerlink" title="T"></a>T</h6><p><code>T</code> 也可以用空格表示，但是这两种表示有点不一样，<code>T</code> 其实表示 <code>UTC</code>，而空格会被认为是本地时区（前提是不通过 <code>Z</code> 指定时区）。比如下面的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'1970-01-01 00:00:00'</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'1970-01-01T00:00:00'</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>示例 1 的空格表示法被当做了本地时区，所以显示的时间和传入的时间一致。</p>
<p>示例 2 的 <code>T</code> 被当做 <code>UTC</code> 时间，所以显示的时间会加上本地时区（东八区）的 8 小时偏移。实际上，<code>1970-01-01T00:00:00</code> 等价于 <code>1970-01-01 00:00:00Z</code>。</p>
<h6 id="Z"><a href="#Z" class="headerlink" title="Z"></a>Z</h6><p><code>Z</code> 用来表示传入时间的时区（zone），不指定并且没有使用 <code>T</code> 分隔而是使用空格分隔时，就按本地时区处理，比如下面的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'1970-01-01T00:00:00+08:00'</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'1970-01-01 00:00:00'</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'1970-01-01T00:00:00+00:00'</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>示例 1 是东八区时间，显示的时间和传入的时间一致（因为我本地时区是东八区）。</p>
<p>示例 2 和示例 1 结果一样，不指定时区就是本地时区。</p>
<p>示例 3 指定时区为 <code>GMT</code> 时区（偏移为 0），显示的时间会加上本地时区的偏移（8 小时）。</p>
<h5 id="RFC-2822"><a href="#RFC-2822" class="headerlink" title="RFC-2822"></a>RFC-2822</h5><p>RFC-2822 的标准格式大概是这样：<code>Wed Mar 25 2015 09:56:24 GMT+0100</code>。其实就是上面显示时间时使用的形式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'Thu Jan 01 1970 00:00:00 GMT+0800 (CST)'</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>除了能表示基本信息，还可以表示星期，但是一点也不容易读，不建议使用。完整的规范可以在这里查看：<a href="http://tools.ietf.org/html/rfc2822#page-14" target="_blank" rel="noopener">http://tools.ietf.org/html/rfc2822#page-14</a></p>
<h4 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h4><p><code>Date</code> 构造器还可以接受整数，表示想要构造的时间自 <code>UTC</code> 时间 <code>1970-01-01 00:00:00</code> 经过的毫秒数。比如下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1000</span> * <span class="number">1</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">01</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>传人 1 秒，等价于：<code>1970-01-01 00:00:01Z</code>，显示的时间加上了本地时区的偏移（8 小时）。</p>
<h4 id="多参数"><a href="#多参数" class="headerlink" title="多参数"></a>多参数</h4><p>最后，<code>Date</code> 构造器还支持传递多个参数，这种方法就没办法指定时区了，都当做本地时间处理。比如下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1970</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>显示时间和传入时间一致，均是本地时间。注意：月份是从 0 开始的。</p>
<h3 id="Date-parse"><a href="#Date-parse" class="headerlink" title="Date.parse"></a>Date.parse</h3><p><code>Date.parse</code> 接受一个时间字符串，如果字符串能正确解析就返回自 <code>UTC</code> 时间 <code>1970-01-01 00:00:00</code> 经过的毫秒数，否则返回 <code>NaN</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">Date</span>.parse(<span class="string">'1970-01-01 00:00:00'</span>)</span><br><span class="line"><span class="number">-28800000</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="built_in">Date</span>.parse(<span class="string">'1970-01-01 00:00:00'</span>))</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">Date</span>.parse(<span class="string">'1970-01-01T00:00:00'</span>)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="built_in">Date</span>.parse(<span class="string">'1970-01-01T00:00:00'</span>))</span><br><span class="line">Thu Jan <span class="number">01</span> <span class="number">1970</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>示例 1，-28800000 换算后刚好是 8 小时表示的毫秒数，<code>28800000 / (1000 * 60 * 60)</code>，我们传入的是本地时区时间，等于 <code>UTC</code> 时间的 <code>1969-12-31 16:00:00</code>，和 <code>UTC</code> 时间 <code>1970-01-01 00:00:00</code> 相差刚好 -8 小时。</p>
<p>示例 2，将 parse 后的毫秒数传递给构造器，最后显示的时间加上了本地时区的偏移（8 小时），所以结果刚好是 <code>1970-01-01 00:00:00</code>。</p>
<p>示例 3，传入的是 <code>UTC</code> 时区时间，所以结果为 0。</p>
<p>示例 4，将 parse 后的毫秒数传递给构造器，最后显示的时间加上了本地时区的偏移（8 小时），所以结果刚好是 <code>1970-01-01 08:00:00</code>。</p>
<h3 id="Date-UTC"><a href="#Date-UTC" class="headerlink" title="Date.UTC"></a>Date.UTC</h3><p><code>Date.UTC</code> 接受的参数和 <code>Date</code> 构造器多参数形式一样，然后返回时间自 <code>UTC</code> 时间 <code>1970-01-01 00:00:00</code> 经过的毫秒数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">Date</span>.UTC(<span class="number">1970</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">Date</span>.parse(<span class="string">'1970-01-01T00:00:00'</span>)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">Date</span>.parse(<span class="string">'1970-01-01 00:00:00Z'</span>)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>可以看出，<code>Date.UTC</code> 进行的是一种“绝对运算”，传入的时间就是 <code>UTC</code> 时间，不会转换为当地时间。</p>
<h3 id="Date-now"><a href="#Date-now" class="headerlink" title="Date.now"></a>Date.now</h3><p><code>Date.now</code> 返回当前时间距 <code>UTC</code> 时间 <code>1970-01-01 00:00:00</code> 经过的毫秒数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">Date</span>.now()</span><br><span class="line"><span class="number">1452520484343</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="built_in">Date</span>.now())</span><br><span class="line">Mon Jan <span class="number">11</span> <span class="number">2016</span> <span class="number">21</span>:<span class="number">54</span>:<span class="number">55</span> GMT+<span class="number">0800</span> (CST)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">Mon Jan <span class="number">11</span> <span class="number">2016</span> <span class="number">21</span>:<span class="number">55</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<h2 id="MySQL-中的“时间”"><a href="#MySQL-中的“时间”" class="headerlink" title="MySQL 中的“时间”"></a>MySQL 中的“时间”</h2><p>MySQL 中和时间相关的数据类型主要包括：<code>YEAR</code>、<code>TIME</code>、<code>DATE</code>、<code>DATETIME</code>、<code>TIMESTAMP</code>。</p>
<p><code>DATE</code>、<code>YEAR</code>、<code>TIME</code> 比较简单，大概总结如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">占用字节</th>
<th style="text-align:left">取值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DATE</td>
<td style="text-align:left">3 字节</td>
<td style="text-align:left">1000-01-01 ~ 9999-12-31</td>
</tr>
<tr>
<td style="text-align:left">YEAR</td>
<td style="text-align:left">1 字节</td>
<td style="text-align:left">1901 ~ 2155</td>
</tr>
<tr>
<td style="text-align:left">TIME</td>
<td style="text-align:left">3 字节</td>
<td style="text-align:left">-838:59:59 ~ 838:59:59</td>
</tr>
</tbody>
</table>
<p>注：<code>TIME</code> 的小时范围可以这么大（超过 24 小时），是因为它还可以用来表示两个时间点之差。</p>
<h3 id="DATEIME-vs-TIMESTAMP"><a href="#DATEIME-vs-TIMESTAMP" class="headerlink" title="DATEIME vs TIMESTAMP"></a>DATEIME vs TIMESTAMP</h3><p>我们主要来说明下 <code>DATETIME</code> 和 <code>TIMESTAMP</code>，可以做下面的总结：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">占用字节</th>
<th style="text-align:left">取值</th>
<th style="text-align:left">受 time_zone 设置影响</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DATETIME</td>
<td style="text-align:left">8 字节</td>
<td style="text-align:left">1000-01-01 00:00:00 ~ 9999-12-31 23:59:59</td>
<td style="text-align:left">否</td>
</tr>
<tr>
<td style="text-align:left">TIMESTAMP</td>
<td style="text-align:left">4 字节</td>
<td style="text-align:left">1970-01-01 00:00:00 ~ 2038-01-19 03:14:07</td>
<td style="text-align:left">是</td>
</tr>
</tbody>
</table>
<p>第一个区别是占用字节不同，导致能表示的时间范围也不一样。</p>
<p>第二个区别是 <code>DATETIME</code> 是“常量”，保存时就是保存时的值，检索时是一样的值，不会改变；而 <code>TIMESTAMP</code> 则是“变量”，保存时数据库服务器将其从<code>time_zone</code> 时区转换为 <code>UTC</code> 时间后保存，检索时将其转换从 <code>UTC</code> 时间转换为 <code>time_zone</code> 时区时间后返回。</p>
<p>比如，我们有下面这样一张表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tests`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> auto_increment ,</span><br><span class="line">    <span class="string">`datetime`</span> DATETIME,</span><br><span class="line">    <span class="string">`timestamp`</span> <span class="built_in">TIMESTAMP</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure>
<p>连接到数据库服务器后，可以执行 <code>SHOW VARIABLES LIKE &#39;%time_zone%&#39;</code> 查看当前时区设置。类似下面这样的结果：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Variable_name</th>
<th style="text-align:left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">system_time_zone</td>
<td style="text-align:left">CST</td>
</tr>
<tr>
<td style="text-align:left">time_zone</td>
<td style="text-align:left">SYSTEM</td>
</tr>
</tbody>
</table>
<p>说明我目前时区是 <code>CST</code>（China  Standard Time），也就是东八区。</p>
<p>我们尝试插入下面的数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`tests`</span> (<span class="string">`id`</span>, <span class="string">`datetime`</span>, <span class="string">`timestamp`</span>) <span class="keyword">VALUES</span> (<span class="keyword">DEFAULT</span>, <span class="string">'1970-01-01 00:00:00'</span>, <span class="string">'1970-01-01 00:00:00'</span>);</span><br></pre></td></tr></table></figure>
<p>会发现有一个报错：<code>Error Code: 1292. Incorrect datetime value: &#39;1970-01-01 00:00:00&#39; for column &#39;timestamp&#39;</code>。给 timestamp 这一列提供的值不对，因为我们尝试插入 <code>1970-01-01 00:00:00</code> 时，数据库服务器会根据 <code>time_zone</code> 的设置将其转换为 <code>UTC</code> 时间，也就是 <code>1969-12-31 16:00:00</code>，而这个值明显超过了 <code>TIMESTAMP</code> 类型的范围。</p>
<p>我们换个大一点的值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`tests`</span> (<span class="string">`id`</span>, <span class="string">`datetime`</span>, <span class="string">`timestamp`</span>) <span class="keyword">VALUES</span> (<span class="keyword">DEFAULT</span>, <span class="string">'2000-01-01 00:00:00'</span>, <span class="string">'2000-01-01 00:00:00'</span>);</span><br></pre></td></tr></table></figure>
<p>这次就成功插入了。</p>
<p>再次检索时结果也是正确的（数据库服务器将值从 <code>UTC</code> 时间转换为 <code>time_zone</code> 设置的时区时间）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sample.tests;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">datetime</th>
<th style="text-align:left">timestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">2000-01-01 00:00:00</td>
<td style="text-align:left">2000-01-01 00:00:00</td>
</tr>
</tbody>
</table>
<p>如果我们先将 <code>time_zone</code> 设置为一个不同的值后再进行检索就会发现不同的结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">time_zone</span> = <span class="string">'+00:00'</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sample.tests;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">datetime</th>
<th style="text-align:left">timestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">2000-01-01 00:00:00</td>
<td style="text-align:left">1999-12-31 16:00:00</td>
</tr>
</tbody>
</table>
<p>可以看到 datetime 列值没有受 <code>time_zone</code> 设置的影响，而 timestamp 列值却改变了。数据库服务器将其从 <code>UTC</code> 时区转换为 <code>time_zone</code> 时区的时间（首先 <code>2000-01-01 00:00:00</code> 在上面进行插入时根据 <code>time_zone</code> 被转换为了 <code>1999-12-31 16:00:00</code>，此次检索时 <code>time_zone</code> 被设置为 <code>+00:00</code>，转换回来刚好就是 <code>1999-12-31 16:00:00</code>）。</p>
<p>那这两种类型怎么选择呢？建议优先使用 <code>DATETIME</code>，表示范围大、不容易受服务器的设置影响。</p>
<h2 id="在-JavaScript-和-MySQL-间转换"><a href="#在-JavaScript-和-MySQL-间转换" class="headerlink" title="在 JavaScript 和 MySQL 间转换"></a>在 JavaScript 和 MySQL 间转换</h2><p>分别说明了 JavaScript 和 MySQL 中的“时间”后，我们来聊聊 ORM 框架一般都是怎么样在两者间进行正确、合适的转换来避免混乱的。下面的说明将基于 sequelize 框架来解释，主要是一种思路，其他的框架可以阅读框架提供的文档或是源码。</p>
<p>sequelize 实际上有一个 <code>timezone</code> 的配置，默认是 <code>+00:00</code>（<a href="http://sequelize.readthedocs.org/en/latest/api/sequelize/" target="_blank" rel="noopener">http://sequelize.readthedocs.org/en/latest/api/sequelize/</a>）。这个 <code>timezone</code> 有下面的用途：</p>
<ul>
<li>建立数据库连接时，执行 <code>SET time_zone = opts.timezone</code></li>
<li>MySQL 的时间类型和 JavaScript 的时间类型的互相转换</li>
</ul>
<p>第一个用途很简单，体现在源码里就是执行一个 <code>SQL</code> 语句：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">"SET time_zone = '"</span> + self.sequelize.options.timezone + <span class="string">"'"</span>); <span class="comment">/* jshint ignore: line */</span></span><br></pre></td></tr></table></figure>
<p>第二个用途主要体现在两个地方：1）在 JavaScript 中调用 ORM 方法进行插入、更新时，需要将 <code>Date</code> 类型转为正确的 SQL 语句；2）从 MySQL 服务器查询数据时，需要将数据库查询到的值转换为 JavaScript 中的 Date 类型。下面我们分别来看一看。</p>
<h3 id="JavaScript-gt-MySQL"><a href="#JavaScript-gt-MySQL" class="headerlink" title="JavaScript -&gt; MySQL"></a>JavaScript -&gt; MySQL</h3><p>这个转换的核心代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SqlString.dateToString = <span class="function"><span class="keyword">function</span>(<span class="params">date, timeZone, dialect</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (moment.tz.zone(timeZone)) &#123;</span><br><span class="line">    date = moment(date).tz(timeZone);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    date = moment(date).utcOffset(timeZone);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dialect === <span class="string">'mysql'</span> || dialect === <span class="string">'mariadb'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> date.format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ZZ here means current timezone, _not_ UTC</span></span><br><span class="line">    <span class="keyword">return</span> date.format(<span class="string">'YYYY-MM-DD HH:mm:ss.SSS Z'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码逻辑如下：</p>
<ol>
<li>检查 <code>timeZone</code> 是否存在，如果存在（存在指的是类似 <code>America/New_York</code> 这样的表示法），调用 <code>tz</code> 设置 <code>date</code> 的时区。</li>
<li>如果不存在（类似 <code>+00:00</code>、<code>-07:00</code> 这样的表示法），调用 <code>utcOffset</code> 设置 <code>date</code> 的相对 <code>UTC</code> 的时区偏移。</li>
<li>最后使用上面设置的时区偏移将其 <code>format</code> 成 MySQL 需要的 <code>YYYY-MM-DD HH:mm:ss</code> 格式。</li>
</ol>
<p>举两个例子。</p>
<p>如果 <code>timeZone</code> 等于 <code>+00:00</code>，date 等于 <code>new Date(&#39;2016-01-12 09:46:00&#39;)</code>，到 <code>UTC</code> 的偏移等于 (timeZone - 本地时区) + timeZone：<code>(00:00 - 08:00) + 00:00 = -08:00</code>，即 <code>2016-01-12 09:46:00-08:00</code>，于是 <code>format</code> 后的结果是 <code>2016-01-12 01:46:00</code>。</p>
<p>如果 <code>timeZone</code> 等于 <code>+08:00</code>，date 等于 <code>new Date(&#39;2016-01-12 09:46:00&#39;)</code>，到 <code>UTC</code> 的偏移等于 (timeZone - 本地时区) + timeZone：<code>(08:00 - 08:00) + 08:00 = 08:00</code>，即 <code>2016-01-12 09:46:00+08:00</code>。于是 <code>format</code> 后的结果是 <code>2016-01-12 09:46:00</code>。</p>
<p>如果 <code>timeZone</code> 等于 <code>Asia/Shanghai</code>，结果也会是 <code>2016-01-12 09:46:00</code>，和 <code>+08:00</code> 等价。</p>
<p>sequelize 的 <code>timezone</code> 默认是 <code>+00:00</code>，所以，我们在 JavaScript 中的时间最后应用到数据库中都会被转换成 <code>UTC</code> 的时间（比实际的时间早 8 小时）。</p>
<h3 id="MySQL-gt-JavaScript"><a href="#MySQL-gt-JavaScript" class="headerlink" title="MySQL -&gt; JavaScript"></a>MySQL -&gt; JavaScript</h3><p>这个转换过程实际上是更底层的 node-mysql 库来实现的。核心代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">switch</span> (field.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> Types.TIMESTAMP:</span><br><span class="line">    <span class="keyword">case</span> Types.DATE:</span><br><span class="line">    <span class="keyword">case</span> Types.DATETIME:</span><br><span class="line">    <span class="keyword">case</span> Types.NEWDATE:</span><br><span class="line">      <span class="keyword">var</span> dateString = parser.parseLengthCodedString();</span><br><span class="line">      <span class="keyword">if</span> (dateStrings) &#123;</span><br><span class="line">        <span class="keyword">return</span> dateString;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> dt;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (dateString === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> originalString = dateString;</span><br><span class="line">      <span class="keyword">if</span> (field.type === Types.DATE) &#123;</span><br><span class="line">        dateString += <span class="string">' 00:00:00'</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (timeZone !== <span class="string">'local'</span>) &#123;</span><br><span class="line">        dateString += <span class="string">' '</span> + timeZone;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      dt = <span class="keyword">new</span> <span class="built_in">Date</span>(dateString);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">isNaN</span>(dt.getTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> originalString;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> dt;</span><br><span class="line">   <span class="comment">// 更多代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理过程大概是这样：</p>
<ol>
<li>用 <code>parser</code> 将服务器返回的二进制数据解析为时间字符串</li>
<li>如果配置了强制返回字符串 <code>dateStrings</code> 而不是转换回 <code>Date</code> 类型，直接返回 <code>dateString</code></li>
<li>如果字段类型是 <code>DATE</code>，时间字符串的时间部分统一为 <code>00:00:00</code></li>
<li>如果配置的 <code>timeZone</code> 不是 <code>local</code>（本地时区），时间字符串加上时区信息</li>
<li>将时间字符串传给 <code>Date</code> 构造器，如果构造出的时间不合法，返回原始时间字符串，否则返回时间对象</li>
</ol>
<p>默认情况下，sequelize 在进行连接时传递给 node-mysql 的 <code>timeZone</code> 是 <code>+00:00</code>，所以，第 4 步的时间字符串会是类似这样的值 <code>2016-01-12 01:46:00+00:00</code>，而这个值传递给 <code>Date</code> 构造器，在显示时转换回本地时区时间，就变成了 <code>2016-01-12 09:46:00</code>（比数据库中的时间晚 8 小时）。</p>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>在使用 sequelize 定义模型时，其实是没有 <code>TIMESTAMP</code> 类型的，sequelize 只提供了一个 <code>Sequelize.DATE</code> 类型，生成建表语句时被转换为 <code>DATETIME</code>。</p>
<p>如果是在旧表上定义模型，而这张旧表刚好有 <code>TIMESTAMP</code> 类型的列，对 <code>TIMESTAMP</code> 类型的列定义模型时还是可以使用 <code>Sequelize.DATE</code>，对操作没有任何影响。但是 <code>TIMESTAMP</code> 是受 <code>time_zone</code> 设置影响的，这会引起一些困惑。下面我们来看一个例子。</p>
<p>sequelize 默认将 <code>time_zone</code> 设置为 <code>+00:00</code>，当我们执行下面代码时：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Test.create(&#123;</span><br><span class="line">    <span class="string">'datetime'</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2016-01-10 20:07:00'</span>),</span><br><span class="line">    <span class="string">'timestamp'</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2016-01-10 20:07:00'</span>)</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>会进行上面提到的 JavaScript 时间到 MySQL 时间字符串的转换，生成的 SQL 其实是（时间被转换为了 <code>UTC</code> 时间，比本地时间早了 8 小时）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`tests`</span> (<span class="string">`id`</span>,<span class="string">`datetime`</span>,<span class="string">`timestamp`</span>) <span class="keyword">VALUES</span> (<span class="keyword">DEFAULT</span>,<span class="string">'2016-01-10 12:07:00'</span>,<span class="string">'2016-01-10 12:07:00'</span>);</span><br></pre></td></tr></table></figure>
<p>当我们执行 <code>Test.findAll()</code> 来查询数据时，会进行上面提到的 MySQL 时间到 JavaScript 时间的转换，其实就是返回这样的结果（显示时时间从 <code>UTC</code> 时间转换回了本地时间）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'2016-01-10 12:07:00+00:00'</span>)</span><br><span class="line">Sun Jan <span class="number">10</span> <span class="number">2016</span> <span class="number">20</span>:<span class="number">07</span>:<span class="number">00</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>
<p>和我们插入时的时间是一致的。</p>
<p>如果我们通过 MySQL 命令行来查询数据时，发现其实是这样的结果：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">datetime</th>
<th style="text-align:left">timestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">2016-01-10 12:07:00</td>
<td style="text-align:left">2016-01-10 20:07:00</td>
</tr>
</tbody>
</table>
<p>这很好理解，因为我们数据库服务器的 <code>time_zone</code> 默认是东八区，<code>TIMESTAMP</code> 是受时区影响的，查询时被数据库服务器从 <code>UTC</code> 时间转换回了 <code>time_zone</code> 时区时间；<code>DATETIME</code> 不受影响，还是 <code>UTC</code> 时间。</p>
<p>如果我们先执行 <code>SET time_zone = &#39;+00:00&#39;</code>，再进行查询，那结果就都会是 <code>UTC</code> 时间了。所以，不要以为数据出错了哦。</p>
<p>总结下就是，sequelize 会将本地时间转换为 <code>UTC</code> 时间后入库，查询时再将 <code>UTC</code> 时间转换为本地时间。这能达到最好的兼容性，存储总是使用 <code>UTC</code> 时间，展示时应用端自己转换为本地时区时间后显示。当然这个的前提是数据类型选用 <code>DATETIME</code>。</p>
<h3 id="兼容老数据"><a href="#兼容老数据" class="headerlink" title="兼容老数据"></a>兼容老数据</h3><p>这里要说的最后一个问题是基于旧表定义 sequelize 模型，并且表中时间值插入时没有转换为 <code>UTC</code> 时间（全部是东八区时间），而且 <code>DATETIME</code> 和 <code>TIMESTAMP</code> 混用，该怎么办？</p>
<p>在默认配置下，情况如下：</p>
<p>查询 <code>DATETIME</code> 类型数据时，时间总是会晚 8 小时。比如，数据库中某条老数据的时间是 <code>2012-01-01 01:00:00</code>（已经是本地时间了，因为没转换），查询时被 sequelize 转换为 <code>new Date(&#39;2012-01-01 01:00:00+00:00&#39;)</code>，显示时转换为本地时间 <code>2012-01-01 09:00:00</code>，结果显然不对。</p>
<p>查询 <code>TIMESTAMP</code> 类型数据时，时间是正确的。这是因为 <code>TIMESTAMP</code> 受 <code>time_zone</code> 影响，sequelize 默认将其设置为 <code>+00:00</code>，查询时数据库服务器先将时间转换到 <code>time_zone</code> 设置的时区时间，由于没有时区偏移，刚好查出来的就是数据库中的值。比如：<code>2012-01-01 00:00:00</code>（注意这个值是 UTC 时间），sequelize 将其转换为 <code>new Date(&#39;2012-01-01 00:00:00+00:00&#39;)</code>，显示时转换为本地时间 <code>2012-01-01 08:00:00</code>，刚好“侥幸”正确。</p>
<p>新插入的数据 sequelize 会进行上一部分说的双向转换来保证结果的正确。</p>
<p>维持默认配置显然导致查询 <code>DATETIME</code> 不准确，解决方法就是将 sequelize 的 <code>timezone</code> 配置为 <code>+08:00</code>。这样一来，情况变成下面这样：</p>
<p>查询 <code>DATETIME</code> 类型数据时，时间 <code>2012-01-01 01:00:00</code> 被转换为 <code>new Date(&#39;2012-01-01 01:00:00+08:00&#39;)</code>，显示时转换为本地时间 <code>2012-01-01 01:00:00</code>，结果正确。</p>
<p>查询 <code>TIMESTAMP</code> 类型数据时，由于 <code>time_zone</code> 被设置为了 <code>+08:00</code>，数据库服务器先将库中 <code>UTC</code> 时间 <code>2011-01-01 00:00:00</code> 转换到 <code>time_zone</code> 时区时间（加上 8 小时偏移）为 <code>2011-01-01 08:00:00</code>，sequelize 将其转换为 <code>new Date(&#39;2011-01-01 08:00:00+08:00&#39;)</code>，显示时转换为本地时间 <code>2011-01-01 08:00:00</code>，结果正确。</p>
<p>插入、更新数据时，所有 JavaScript 时间会转换为东八区时间入库。</p>
<p>这样带来的问题是，所有入库时间都是东八区时间，如果有其他应用的时区不是东八区，那就需要自己基于东八区时间计算偏移并转换时间后显示了。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>一不小心写的有点长了，下面列出参考资料供大家进一步学习：</p>
<ul>
<li><a href="http://www.timeanddate.com/time/gmt-utc-time.html" target="_blank" rel="noopener">http://www.timeanddate.com/time/gmt-utc-time.html</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/UTC" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/UTC</a></li>
<li><a href="http://tools.ietf.org/html/rfc2822#page-14" target="_blank" rel="noopener">http://tools.ietf.org/html/rfc2822#page-14</a></li>
<li><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.1.15" target="_blank" rel="noopener">http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.1.15</a></li>
<li><a href="http://www.w3schools.com/js/js_date_formats.asp" target="_blank" rel="noopener">http://www.w3schools.com/js/js_date_formats.asp</a></li>
<li><a href="http://momentjs.com/timezone/docs/" target="_blank" rel="noopener">http://momentjs.com/timezone/docs/</a></li>
<li><a href="http://sequelize.readthedocs.org/en/latest/api/sequelize/" target="_blank" rel="noopener">http://sequelize.readthedocs.org/en/latest/api/sequelize/</a></li>
<li><a href="https://github.com/felixge/node-mysql" target="_blank" rel="noopener">https://github.com/felixge/node-mysql</a></li>
<li>《MySQL 技术内幕》</li>
</ul>
<p>本文采用 <a href="http://creativecommons.org/licenses/by/3.0/cn" target="_blank" rel="noopener">知识共享署名 3.0 中国大陆许可协议</a>，可自由转载、引用，但需署名作者且注明文章出处 。</p>

      
    </div>
    
    <div>
      
        
      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2016/01/06/about-a-sql-debug/" rel="next" title="记一次 MySQL 数据库问题排查">
                <i class="fa fa-chevron-left"></i> 记一次 MySQL 数据库问题排查
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2016/03/15/handle-error-in-koa/" rel="prev" title="如何优雅的在 koa 中处理错误">
                如何优雅的在 koa 中处理错误 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/01/12/tour-for-date-in-js-and-mysql/" data-title="关于“时间”的一次探索" data-url="http://kohpoll.github.io/blog/2016/01/12/tour-for-date-in-js-and-mysql/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="https://avatars3.githubusercontent.com/u/1203543?v=3&s=460" alt="kohpoll">
          <p class="site-author-name" itemprop="name">kohpoll</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">18</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概念"><span class="nav-number">1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JavaScript-中的“时间”"><span class="nav-number">2.</span> <span class="nav-text">JavaScript 中的“时间”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Date-构造器"><span class="nav-number">2.1.</span> <span class="nav-text">Date 构造器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#时间字符串"><span class="nav-number">2.1.1.</span> <span class="nav-text">时间字符串</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ISO-8601"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">ISO 8601</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#T"><span class="nav-number">2.1.1.1.1.</span> <span class="nav-text">T</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Z"><span class="nav-number">2.1.1.1.2.</span> <span class="nav-text">Z</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RFC-2822"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">RFC-2822</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时间戳"><span class="nav-number">2.1.2.</span> <span class="nav-text">时间戳</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多参数"><span class="nav-number">2.1.3.</span> <span class="nav-text">多参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Date-parse"><span class="nav-number">2.2.</span> <span class="nav-text">Date.parse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Date-UTC"><span class="nav-number">2.3.</span> <span class="nav-text">Date.UTC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Date-now"><span class="nav-number">2.4.</span> <span class="nav-text">Date.now</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL-中的“时间”"><span class="nav-number">3.</span> <span class="nav-text">MySQL 中的“时间”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DATEIME-vs-TIMESTAMP"><span class="nav-number">3.1.</span> <span class="nav-text">DATEIME vs TIMESTAMP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在-JavaScript-和-MySQL-间转换"><span class="nav-number">4.</span> <span class="nav-text">在 JavaScript 和 MySQL 间转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JavaScript-gt-MySQL"><span class="nav-number">4.1.</span> <span class="nav-text">JavaScript -&gt; MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-gt-JavaScript"><span class="nav-number">4.2.</span> <span class="nav-text">MySQL -&gt; JavaScript</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一个例子"><span class="nav-number">4.3.</span> <span class="nav-text">一个例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#兼容老数据"><span class="nav-number">4.4.</span> <span class="nav-text">兼容老数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kohpoll</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/blog/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/blog/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/blog/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/blog/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v="></script>



  
  


  <script type="text/javascript" src="/blog/js/src/affix.js?v="></script>

  <script type="text/javascript" src="/blog/js/src/schemes/pisces.js?v="></script>



  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v="></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v="></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v="></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"kohpoll"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
